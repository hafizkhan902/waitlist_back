<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popup OAuth Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid rgba(40, 167, 69, 0.5);
            color: #d4edda;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: #f8d7da;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .user-info {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .code {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            font-size: 14px;
            margin: 15px 0;
        }
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .profile-pic {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: 600;
        }
        .status.success { background: rgba(40, 167, 69, 0.3); }
        .status.error { background: rgba(220, 53, 69, 0.3); }
        .status.info { background: rgba(23, 162, 184, 0.3); }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Popup OAuth Demo</h1>
        <p>This demo shows how to implement Google OAuth using popup windows instead of page redirects.</p>
        
        <div class="status info">
            <strong>Status:</strong> <span id="status">Ready to authenticate</span>
        </div>
        
        <div>
            <button onclick="initiatePopupOAuth()" id="oauthBtn">
                <span id="btnText">üîê Join with Google (Popup)</span>
            </button>
            <button onclick="checkAuthStatus()">üë§ Check Auth Status</button>
            <button onclick="logout()">üö™ Logout</button>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        let popupWindow = null;
        let isAuthenticating = false;

        // Listen for messages from popup window
        window.addEventListener('message', function(event) {
            // Verify the origin for security
            if (event.origin !== window.location.origin && 
                event.origin !== 'http://localhost:2000' && 
                event.origin !== 'https://localhost:2000') {
                return;
            }

            const data = event.data;
            console.log('Received message from popup:', data);
            
            if (data.success) {
                handleSuccess(data);
            } else {
                handleError(data);
            }
            
            // Close popup if it's still open
            if (popupWindow && !popupWindow.closed) {
                popupWindow.close();
            }
            
            isAuthenticating = false;
            updateButtonState();
        });

        function initiatePopupOAuth() {
            if (isAuthenticating) return;
            
            isAuthenticating = true;
            updateButtonState();
            updateStatus('Opening Google OAuth popup...');
            
            // Clear previous results
            document.getElementById('result').innerHTML = '';
            
            // Open popup window
            const popupUrl = 'http://localhost:2000/api/auth/google/popup';
            const popupFeatures = 'width=500,height=600,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no';
            
            popupWindow = window.open(popupUrl, 'googleOAuth', popupFeatures);
            
            if (!popupWindow) {
                handleError({ error: 'Popup blocked! Please allow popups for this site.' });
                isAuthenticating = false;
                updateButtonState();
                return;
            }
            
            // Check if popup was closed manually
            const checkClosed = setInterval(() => {
                if (popupWindow.closed) {
                    clearInterval(checkClosed);
                    if (isAuthenticating) {
                        updateStatus('Authentication cancelled by user');
                        isAuthenticating = false;
                        updateButtonState();
                    }
                }
            }, 1000);
            
            // Timeout after 5 minutes
            setTimeout(() => {
                if (isAuthenticating) {
                    handleError({ error: 'Authentication timeout. Please try again.' });
                    if (popupWindow && !popupWindow.closed) {
                        popupWindow.close();
                    }
                    isAuthenticating = false;
                    updateButtonState();
                }
            }, 300000); // 5 minutes
        }

        function handleSuccess(data) {
            updateStatus('‚úÖ Authentication successful!');
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div class="success">
                    <h3>üéâ ${data.message}</h3>
                    <div class="user-info">
                        <h4>üë§ User Information:</h4>
                        <p><strong>Name:</strong> ${data.user.name || 'N/A'}</p>
                        <p><strong>Email:</strong> ${data.user.email}</p>
                        <p><strong>Source:</strong> ${data.user.source}</p>
                        <p><strong>Referral Code:</strong> ${data.user.referralCode || 'N/A'}</p>
                        ${data.user.picture ? `<img src="${data.user.picture}" alt="Profile" class="profile-pic">` : ''}
                        <p><strong>User ID:</strong> ${data.user.id}</p>
                    </div>
                </div>
            `;
            
            // Store user data in localStorage
            localStorage.setItem('user', JSON.stringify(data.user));
        }

        function handleError(data) {
            updateStatus('‚ùå Authentication failed');
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div class="error">
                    <h3>‚ùå ${data.error || 'Authentication failed'}</h3>
                    <p>Please try again or contact support if the problem persists.</p>
                </div>
            `;
        }

        function updateButtonState() {
            const btn = document.getElementById('oauthBtn');
            const btnText = document.getElementById('btnText');
            
            if (isAuthenticating) {
                btn.disabled = true;
                btnText.innerHTML = '<span class="loading"></span>Authenticating...';
            } else {
                btn.disabled = false;
                btnText.innerHTML = 'üîê Join with Google (Popup)';
            }
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function checkAuthStatus() {
            updateStatus('Checking authentication status...');
            
            fetch('http://localhost:2000/api/auth/status')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        updateStatus('‚úÖ User is authenticated');
                        displayUserInfo(data.user);
                    } else {
                        updateStatus('‚ùå User is not authenticated');
                        document.getElementById('result').innerHTML = `
                            <div class="error">
                                <h3>‚ùå Not authenticated</h3>
                                <p>Please sign in with Google to continue.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error checking auth status:', error);
                    updateStatus('‚ùå Error checking status');
                    document.getElementById('result').innerHTML = `
                        <div class="error">
                            <h3>‚ùå Error checking authentication status</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                });
        }

        function displayUserInfo(user) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div class="success">
                    <h3>‚úÖ User is authenticated</h3>
                    <div class="user-info">
                        <h4>üë§ User Information:</h4>
                        <p><strong>Name:</strong> ${user.name || 'N/A'}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Source:</strong> ${user.source}</p>
                        <p><strong>Referral Code:</strong> ${user.referralCode || 'N/A'}</p>
                        ${user.picture ? `<img src="${user.picture}" alt="Profile" class="profile-pic">` : ''}
                        <p><strong>Joined:</strong> ${new Date(user.joinedAt).toLocaleDateString()}</p>
                    </div>
                </div>
            `;
        }

        function logout() {
            updateStatus('Logging out...');
            
            fetch('http://localhost:2000/api/auth/logout')
                .then(response => response.json())
                .then(data => {
                    updateStatus('‚úÖ Logged out successfully');
                    document.getElementById('result').innerHTML = `
                        <div class="success">
                            <h3>‚úÖ ${data.message}</h3>
                        </div>
                    `;
                    localStorage.removeItem('user');
                })
                .catch(error => {
                    console.error('Error logging out:', error);
                    updateStatus('‚ùå Error during logout');
                });
        }

        // Check for existing user data on page load
        window.onload = function() {
            const userData = localStorage.getItem('user');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    updateStatus('‚úÖ User data found in localStorage');
                    displayUserInfo(user);
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    localStorage.removeItem('user');
                }
            }
        };
    </script>

    <div class="container" style="margin-top: 30px;">
        <h2>üìö Frontend Implementation Guide</h2>
        
        <h3>1. React Implementation</h3>
        <div class="code">
import { useState, useEffect } from 'react';

function GoogleOAuthButton() {
  const [isAuthenticating, setIsAuthenticating] = useState(false);
  const [user, setUser] = useState(null);

  useEffect(() => {
    // Listen for messages from popup
    const handleMessage = (event) => {
      if (event.origin !== window.location.origin && 
          event.origin !== 'http://localhost:2000') {
        return;
      }

      const data = event.data;
      if (data.success) {
        setUser(data.user);
        localStorage.setItem('user', JSON.stringify(data.user));
      }
      setIsAuthenticating(false);
    };

    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, []);

  const handleGoogleAuth = () => {
    if (isAuthenticating) return;
    
    setIsAuthenticating(true);
    const popup = window.open(
      'http://localhost:2000/api/auth/google/popup',
      'googleOAuth',
      'width=500,height=600,scrollbars=yes,resizable=yes'
    );

    if (!popup) {
      alert('Please allow popups for this site');
      setIsAuthenticating(false);
    }
  };

  return (
    &lt;button 
      onClick={handleGoogleAuth} 
      disabled={isAuthenticating}
    &gt;
      {isAuthenticating ? 'Authenticating...' : 'Join with Google'}
    &lt;/button&gt;
  );
}
        </div>

        <h3>2. Next.js Implementation</h3>
        <div class="code">
import { useState, useEffect } from 'react';

export default function GoogleOAuthButton() {
  const [isAuthenticating, setIsAuthenticating] = useState(false);
  const [user, setUser] = useState(null);

  useEffect(() => {
    const handleMessage = (event) => {
      if (event.origin !== window.location.origin && 
          event.origin !== 'http://localhost:2000') {
        return;
      }

      const data = event.data;
      if (data.success) {
        setUser(data.user);
        localStorage.setItem('user', JSON.stringify(data.user));
      }
      setIsAuthenticating(false);
    };

    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, []);

  const handleGoogleAuth = () => {
    if (isAuthenticating) return;
    
    setIsAuthenticating(true);
    const popup = window.open(
      'http://localhost:2000/api/auth/google/popup',
      'googleOAuth',
      'width=500,height=600,scrollbars=yes,resizable=yes'
    );

    if (!popup) {
      alert('Please allow popups for this site');
      setIsAuthenticating(false);
    }
  };

  return (
    &lt;button 
      onClick={handleGoogleAuth} 
      disabled={isAuthenticating}
    &gt;
      {isAuthenticating ? 'Authenticating...' : 'Join with Google'}
    &lt;/button&gt;
  );
}
        </div>

        <h3>3. Environment Variables</h3>
        <p>Add these to your backend .env file:</p>
        <div class="code">
GOOGLE_CALLBACK_POPUP=http://localhost:2000/api/auth/google/callback/popup
FRONTEND_URL=http://localhost:3000
        </div>

        <h3>4. Security Considerations</h3>
        <ul>
            <li>Always verify the origin of postMessage events</li>
            <li>Set appropriate popup dimensions</li>
            <li>Handle popup blocking gracefully</li>
            <li>Implement timeout for authentication</li>
            <li>Store sensitive data securely</li>
        </ul>
    </div>
</body>
</html> 